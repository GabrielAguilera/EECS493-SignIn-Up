
<!doctype html>
<head>
  <meta charset="utf-8">

  <title>Fitness Carrot</title>
  <meta name="description" content="Fitness Carrot - An application developed in EECS 493 - User Interfaces, W'14">
  <meta name="viewport" content="width=device-width">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.18.min.js"></script>
</head>

<body>
  <div id="main">




    <script type="text/javascript">
        Parse.initialize("PAjzQPglIFtzZyMJfDPe5Ozvfzr7Pz1ukpHoLXct", "zTU8emhQIg5xTKZrhfF5ulrKnXQv4M6ztT9kFi90");

      Parse.User.logOut();
      //var username = "username";
      //var password = "password";


      Parse.User.logIn("wale", "test", {
          success: function (user) {
            // if login is successful
            alert("Welcome, " + user.get("firstName") + " " + user.get("lastName"));
            user.increment("loginCounter");
            user.save();


/******* ACCEPTING FRIENDS ********/

            //Checks if there's pending requests
            if(user.get("pendingRequests").length > 0){
              //Grabs the array.
              var pendingRequests = user.get("pendingRequests");
              //Right now, defaults to accepting all of them.
              for(var i = 0; i < pendingRequests.length; i++){
                //Gets the username
                var pendingUsername = pendingRequests[i];
                //Looks in the User table
                var usernameLookup = new Parse.Query(Parse.User);
                //Searches for that username
                usernameLookup.equalTo("username", "username");
                var friendObject = new Parse.User();
                usernameLookup.first({
                  success: function(friendObject){
                    debugger;
                    //Grab the returned friend object
                    var friendSentRequests = friendObject.get("sentRequests");
                    //Get the index of the username that just accepted.
                    var sliceIndex = friendSentRequests.indexOf(user.get("username"));
                    //If it's in range...
                    if(sliceIndex > -1){
                      //Splice the friend array.
                      friendSentRequests.splice(sliceIndex, 1);
                      //Give it the new array
                      var targetFriendUsername = friendObject.get("username");
                      var updatedFriendUsernames = friendObject.get("friendUsernames");
                      updatedFriendUsernames.push(user.get("username"));
                      Parse.Cloud.run('acceptFriend', {
                                                        acceptedFriend: targetFriendUsername,
                                                        updatedFriends: updatedFriendUsernames,
                                                        updatedSent: friendSentRequests
                                                      }, 
                        {
                          success: function(result) {
                            // // the friend was updated successfully
                            // //Now push that friend username to your friends list.
                            var updatedPending = user.get("pendingRequests");
                            var updatedPendingIndex = updatedPending.indexOf(user.get("username"));
                            updatedPending.splice(updatedPendingIndex,1);
                            user.add("friendUsernames", targetFriendUsername);
                            user.set("pendingRequests", updatedPending);
                            // //Push it to Parse.
                            user.save();
                          },
                          error: function(error) {
                            alert("Couldn't update remote user." + error.message);
                          }
                        });
                    }
                  },
                  error: function(error){
                    alert("Couldn't find username in Parse. :(");
                  }
                });
              }
            }

            user.fetch({
              success: function(user){
                    //user has been refreshed.
              },
              error: function (error){
                alert("Couldn't refresh user!");
              }
            });
          },
          error: function (user, error) {
              // Show the error message somewhere and let the user try again.
              alert("Error: " + error.code + " " + error.message);
          }
      });
    </script>

  </div>
</body>
</html>



